Обслуживание посредством консоли Symfony2
=========================================

## Предварительные сведения

* Некоторые директории сайта должны иметь права на запись и чтение и для пользователя(linux) сервера, и для пользователя ssh.
  Соответственно на данный момент я устанавливаю в качестве владельца директорий и файлов пользователя www-data и группу www-data.
    
* Скорее всего есть более гибкое решение, позволяющее модифицировать файлы из-под разных пользователей, но для настройки нужны более глубокие познания администрирования linux.
  Предложения по этому пункту приветствуются.
  
* На данный момент для избежания ошибок все последующие команды выполняются из под `sudo`:
 
  ```
  sudo -u www-data <command> <...arguments...>
  ```
  
* Команды консоли symfony2 можно сокращать (но чтобы н было неоднозначностей). При этом позиции символа двоеточие (`:`) должны сохраняться. Например:
 
  ```
  // вместо... 
  php app/console cache:clear
  
  // ...писать так
  php app/console ca:cl
  ```
  
* По умолчанию в консольных командах используется dev-окружение (которое работает с урлами с префиксом /app_dev.php/).
  Для того чтобы запускать их под окружением продакшена нужно использовать параметр `--env=prod`, например:
  
  ```
  php app/console ca:cl --env=prod
  ```
  
  Без этого команда очистки кэша, например, будет очищать кэш dev-окружения. И, соответственно, продакшен не запустится или будет глючить.
  
* Под кэшем в Symfony2 подразумевается очень многое. Все twig-шаблоны компилируются в php-классы (существенно производительнее чем инклюды),
  DIC-контейнер и все описания сервисов компилируются в единый класс, так что эта процедура происходит лишь однажды. 
  Все аннотации сущностей также компилируются лишь однажды. И это лишь часть того что происходит. 
  Кроме того, dev-окружение по большей части валидирует изменения в коде на лету (кроме некоторых исключений),
  а prod-окружение совсем не валидирует изменений для максимальной производительности.  
  
* для вывода всех доступных команд консоли (встроенных в symfony2, а также добавленных бандлами), нужно запустить консоль без параметров:

  ```
  php app/console
  ```
  
* dev-окружение (в файле web/app_dev.php) по умолчанию открыто только для локальных IP, так что в дальнейшем его надо будет заблокировать,
  либо указать доверенные IP.

## Процесс обновления

#### 1. Заблокировать сайт. При этом сайт начнёт выдавать ошибку 503 Service Unavailable.
  
```
php app/console lexik:maintenance:lock         
```

#### 2. Обновляемся с `git pull`:

```
git pull
```

##### 2.1 Если были проблемы при `git pull`, например какие-то файлы изменены (временно для отладки), можно сбросить код к последнему коммиту на сервере:
 
```
git reset --hard HEAD
```

а затем повторить пункт №2.

#### 3. Проводим инсталляцию изменений:

```
php composer.phar install  
```

либо, если возникла ошибка:

```
php composer.phar update  
```

Во время инсталляции происходят типичные операции композера, а также несколько триггеров Symfony2:

* устанавливаются ресурсы (css, js, картинки) бандлов в папку web

* очищается кэш под текущим окружением (dev)
 
Для для того, чтобы установить ресурсы вручную, можно воспользоваться командой:
 
```
php app/console assets:install --symlink
```

#### 4. Обновить скомпилированные ресурсы фронтенда (если менялись):

На фронтенде используется бандл Assetic, который объединяет ресурсы в один файл (или несколько), и может производить множество других операций с ресурсами.
В нашем случае он объединяет по несколько css файлов в один, и по несколько js файлов в один. 
В итоге образуются несколько css- и js-файлов разумного размера, сгрупированные по смыслу. 
Компилируются файлы так:

```
php app/console assetic:dump --env=prod
```

#### 5. Установка миграций.

Миграции Symfony2 по своей сути двунаправленные. Они содержат код и для установки своих изменений, и для их отмены. 
Для отслеживания текущей версии в БД создаётся отдельная таблица.
Классы миграций хранятся в директории `app/DoctrineMigrations`. 
Для типового обновления БД в связи с изменениями схемы используется следующая команда.
 
```
php app/console doctrine:migrations:migrate
```
После ввода команды следовать инструкциям.

#### 6. Финальная очистка кэша 

```
php app/console cache:clear --env=prod
```

также можно прогреть некоторые части кэша (которые это умеют):

```
php app/console cache:warmup --env=prod
```

#### 7. Разблокировать сайт:

```
php app/console lexik:maintenance:unlock         
```

или проще:

```
php app/console lex:main:un         
```

